<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Productos - El Bambino</title>
    <link rel="icon" type="image/webp" href="/imagenes/logo/Logo.webp" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/admin-panel.css">
    <link rel="stylesheet" href="/css/admin-panel-custom.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Productos</h1>
            <span id="bienvenida-usuario" class="fw-bold"></span>
            <a href="/admin-panel" class="btn btn-secondary">Volver</a>
        </div>
        <div class="mb-3">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCrearProducto">Crear Producto</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Categoría</th>
                        <th>Precio Compra</th>
                        <th>Precio Venta</th>
                        <th>Stock</th>
                        <th>Unidad</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se cargarán los productos -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Crear Producto -->
    <div class="modal fade" id="modalCrearProducto" tabindex="-1" aria-labelledby="modalCrearProductoLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formCrearProducto">
            <div class="modal-header">
              <h5 class="modal-title" id="modalCrearProductoLabel">Crear Producto</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nombreProducto" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="nombreProducto" required maxlength="100">
                </div>
                <div class="mb-3">
                    <label for="descripcionProducto" class="form-label">Descripción</label>
                    <textarea class="form-control" id="descripcionProducto" maxlength="255"></textarea>
                </div>
                <div class="mb-3">
                    <label for="categoriaProducto" class="form-label">Categoría</label>
                    <select class="form-select" id="categoriaProducto" required></select>
                </div>
                <div class="mb-3">
                    <label for="precioCompra" class="form-label">Precio Compra</label>
                    <input type="number" class="form-control" id="precioCompra" required min="0" step="0.01">
                </div>
                <div class="mb-3">
                    <label for="precioVenta" class="form-label">Precio Venta</label>
                    <input type="number" class="form-control" id="precioVenta" required min="0" step="0.01">
                </div>
                <div class="mb-3">
                    <label for="stock" class="form-label">Stock</label>
                    <input type="number" class="form-control" id="stock" required min="0" step="1">
                </div>
                <div class="mb-3">
                    <label for="unidadMedida" class="form-label">Unidad de Medida</label>
                    <input type="text" class="form-control" id="unidadMedida" maxlength="10" value="UND">
                </div>
                <div class="mb-3">
                    <label for="estadoProducto" class="form-label">Estado</label>
                    <select class="form-select" id="estadoProducto">
                        <option value="1" selected>Activo</option>
                        <option value="0">Inactivo</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Crear</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Editar Producto -->
    <div class="modal fade" id="modalEditarProducto" tabindex="-1" aria-labelledby="modalEditarProductoLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formEditarProducto">
            <div class="modal-header">
              <h5 class="modal-title" id="modalEditarProductoLabel">Editar Producto</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editIdProducto">
                <div class="mb-3">
                    <label for="editNombreProducto" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="editNombreProducto" required maxlength="100">
                </div>
                <div class="mb-3">
                    <label for="editDescripcionProducto" class="form-label">Descripción</label>
                    <textarea class="form-control" id="editDescripcionProducto" maxlength="255"></textarea>
                </div>
                <div class="mb-3">
                    <label for="editCategoriaProducto" class="form-label">Categoría</label>
                    <select class="form-select" id="editCategoriaProducto" required></select>
                </div>
                <div class="mb-3">
                    <label for="editPrecioCompra" class="form-label">Precio Compra</label>
                    <input type="number" class="form-control" id="editPrecioCompra" required min="0" step="0.01">
                </div>
                <div class="mb-3">
                    <label for="editPrecioVenta" class="form-label">Precio Venta</label>
                    <input type="number" class="form-control" id="editPrecioVenta" required min="0" step="0.01">
                </div>
                <div class="mb-3">
                    <label for="editStock" class="form-label">Stock</label>
                    <input type="number" class="form-control" id="editStock" required min="0" step="1">
                </div>
                <div class="mb-3">
                    <label for="editUnidadMedida" class="form-label">Unidad de Medida</label>
                    <input type="text" class="form-control" id="editUnidadMedida" maxlength="10">
                </div>
                <div class="mb-3">
                    <label for="editEstadoProducto" class="form-label">Estado</label>
                    <select class="form-select" id="editEstadoProducto">
                        <option value="1">Activo</option>
                        <option value="0">Inactivo</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let productosCache = [];
        let categoriasCache = [];

        function cargarCategoriasSelect(selectId, selectedId) {
            fetch('/api/categorias')
                .then(res => res.json())
                .then(categorias => {
                    categoriasCache = categorias;
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Seleccione...</option>';
                    categorias.forEach(cat => {
                        select.innerHTML += `<option value="${cat.idCategoria}" ${selectedId == cat.idCategoria ? 'selected' : ''}>${cat.nombreCategoria}</option>`;
                    });
                });
        }

        function cargarProductos() {
            fetch('/api/productos')
                .then(res => res.json())
                .then(productos => {
                    productosCache = productos;
                    renderTablaProductos(productos);
                });
        }

        function renderTablaProductos(productos) {
            const tbody = document.querySelector('table tbody');
            tbody.innerHTML = '';
            if (!Array.isArray(productos) || productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No hay productos registrados.</td></tr>';
                return;
            }
            productos.forEach(prod => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${prod.idProducto}</td>
                    <td>${prod.nombre}</td>
                    <td>${prod.descripcion || ''}</td>
                    <td>${prod.idCategoria} - ${prod.nombreCategoria || ''}</td>
                    <td>${prod.precioCompra}</td>
                    <td>${prod.precioVenta}</td>
                    <td>${prod.stock}</td>
                    <td>${prod.unidadMedida}</td>
                    <td>${prod.estado == 1 ? 'Activo' : 'Inactivo'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="abrirModalEditarProducto(${prod.idProducto})">Editar</button>
                        <button class="btn btn-danger btn-sm ms-1" onclick="eliminarProducto(${prod.idProducto})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Crear producto
        document.getElementById('formCrearProducto').onsubmit = function(e) {
            e.preventDefault();
            const data = {
                nombre: document.getElementById('nombreProducto').value.trim(),
                descripcion: document.getElementById('descripcionProducto').value.trim(),
                idCategoria: document.getElementById('categoriaProducto').value,
                precioCompra: document.getElementById('precioCompra').value,
                precioVenta: document.getElementById('precioVenta').value,
                stock: document.getElementById('stock').value,
                unidadMedida: document.getElementById('unidadMedida').value.trim(),
                estado: document.getElementById('estadoProducto').value
            };
            fetch('/api/productos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => {
                if (res.ok) {
                    cargarProductos();
                    bootstrap.Modal.getInstance(document.getElementById('modalCrearProducto')).hide();
                    this.reset();
                } else {
                    alert('No se pudo crear el producto');
                }
            });
        };

        // Abrir modal editar producto
        function abrirModalEditarProducto(id) {
            const prod = productosCache.find(p => p.idProducto == id);
            if (!prod) return;
            document.getElementById('editIdProducto').value = prod.idProducto;
            document.getElementById('editNombreProducto').value = prod.nombre;
            document.getElementById('editDescripcionProducto').value = prod.descripcion || '';
            cargarCategoriasSelect('editCategoriaProducto', prod.idCategoria);
            document.getElementById('editPrecioCompra').value = prod.precioCompra;
            document.getElementById('editPrecioVenta').value = prod.precioVenta;
            document.getElementById('editStock').value = prod.stock;
            document.getElementById('editUnidadMedida').value = prod.unidadMedida;
            document.getElementById('editEstadoProducto').value = prod.estado;
            var modal = new bootstrap.Modal(document.getElementById('modalEditarProducto'));
            modal.show();
        }

        // Editar producto
        document.getElementById('formEditarProducto').onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('editIdProducto').value;
            const data = {
                nombre: document.getElementById('editNombreProducto').value.trim(),
                descripcion: document.getElementById('editDescripcionProducto').value.trim(),
                idCategoria: document.getElementById('editCategoriaProducto').value,
                precioCompra: document.getElementById('editPrecioCompra').value,
                precioVenta: document.getElementById('editPrecioVenta').value,
                stock: document.getElementById('editStock').value,
                unidadMedida: document.getElementById('editUnidadMedida').value.trim(),
                estado: document.getElementById('editEstadoProducto').value
            };
            fetch('/api/productos/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => {
                if (res.ok) {
                    cargarProductos();
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarProducto')).hide();
                } else {
                    alert('No se pudo editar el producto');
                }
            });
        };

        function eliminarProducto(id) {
            if (!confirm('¿Seguro que deseas eliminar este producto?')) return;
            fetch('/api/productos/' + id, {
                method: 'DELETE'
            })
            .then(res => {
                if (res.ok) {
                    cargarProductos();
                } else if (res.status === 409) {
                    alert('No se puede eliminar el producto porque está relacionado con otros registros.');
                } else {
                    alert('No se pudo eliminar el producto');
                }
            });
        }

        // Inicializar selects y tabla
        cargarCategoriasSelect('categoriaProducto');
        cargarProductos();

        fetch('/api/usuario-actual')
            .then(res => res.ok ? res.json() : null)
            .then(data => {
                if (data && data.username) {
                    document.getElementById('bienvenida-usuario').textContent = "Bienvenido, " + data.username;
                }
            });
    </script>
</body>
</html>
